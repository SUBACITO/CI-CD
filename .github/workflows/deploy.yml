name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Telegram Notification
  if: always()
  run: |
    DEPLOY_STATUS="${{ job.status }}"
    REPO_NAME="${{ github.repository }}"
    COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
    COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
    COMMIT_SHA="${{ github.sha }}"
    BRANCH="${{ github.ref_name }}"

    COMMIT_URL="https://github.com/${{ github.repository }}/commit/$COMMIT_SHA"
    REPO_URL="https://github.com/${{ github.repository }}"
    ACTION_RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    SHORT_SHA="${COMMIT_SHA:0:7}"

    if [ "$DEPLOY_STATUS" = "success" ]; then
      STATUS_EMOJI="‚úÖ"
      STATUS_TEXT="*SUCCESS*"
      STATUS_DESC="Deployed successfully!"
    else
      STATUS_EMOJI="‚ùå"
      STATUS_TEXT="*FAILED*"
      STATUS_DESC="Deployment failed!"
    fi

    read -r -d '' MESSAGE <<EOF || true
$STATUS_EMOJI *DEPLOY $STATUS_TEXT*

üì¶ *Repo:* $REPO_NAME
üåø *Branch:* $BRANCH
üÜî *Commit:* $SHORT_SHA
üë§ *Author:* $COMMIT_AUTHOR
üìù *Message:* $COMMIT_MESSAGE

üöÄ Action: $ACTION_RUN_URL
EOF

    curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
      -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
      -d text="$MESSAGE" \
      -d parse_mode="Markdown" \
      -d disable_web_page_preview="true" || true
